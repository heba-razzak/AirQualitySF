---
title: "Data Preprocessing"
output: github_document
---

```{r setup, include=FALSE}
weather_directory <- readr::read_file("inputs/weather_directory.txt")
osm_directory <- readr::read_file("inputs/osm_directory.txt")
purpleair_directory <- readr::read_file("inputs/purpleair_directory.txt")
uber_directory <- readr::read_file("inputs/uber_directory.txt")
preprocessing_directory <- readr::read_file("inputs/preprocessing_directory.txt")
```

## Load required libraries
```{r, load-libraries, message = FALSE, warning = FALSE}
library(dplyr) # For data manipulation
library(data.table) # Faster than dataframes (for big files)
library(sf) # For working with spatial data
library(mapview) # For interactive maps
library(lubridate) # Dates
library(purrr) 
```

### Coordinate reference system (CRS) that will be used for all shapefiles
### CRS: 4326 in degrees (sphere)
### CRS: 3857 in meters (flat map) - didnt work with getbb
```{r, eval=FALSE}
crs = 4326
```

## Read files
```{r, read-files, eval=FALSE}
purpleair_data <- fread(paste0(purpleair_directory,"/purple_air_sanfran_2018-2019.csv"))
purpleair_sensors <- st_read(paste0(purpleair_directory, "/purpleair_sensors.gpkg"))
weather_stations <- st_read(paste0(weather_directory, "/weather_stations.gpkg"))

osm_roads <- st_read(paste0(osm_directory, "/sanfrangrid_roads_osm.gpkg"), quiet = TRUE)
osm_buildings <- st_read(paste0(osm_directory, "/sanfrangrid_buildings_osm.gpkg"), quiet = TRUE)
osm_trees <- st_read(paste0(osm_directory, "/sanfrangrid_trees_osm.gpkg"), quiet = TRUE)

# weather <- fread(paste0(weather_directory, "/weather.csv"))
# uber_2018 <- fread(paste0(uber_directory, "/uber-2018.csv"))
# uber_2019 <- fread(paste0(uber_directory, "/uber-2019.csv"))
```

# PurpleAir Sensors & Nearest Weather Station

## Filter PurpleAir sensors
```{r, filter_pa_sensors}
# filter purpleair_sensors for our selected data
filtered_sensors <- purpleair_sensors %>% 
  filter(sensor_index %in% unique(purpleair_data$sensor_index))
```

## Nearest Weather Stations
```{r, nearest-weather-station}
# Find the index of the nearest weather station for each sensor
nearest_station_index <- st_nearest_feature(filtered_sensors, weather_stations)

# Add nearest weather stations to purpleair data frame
filtered_sensors$weatherstation <- weather_stations$id[nearest_station_index]

# filtered_sensors: LINKS PA - WEATHER
```

## Map PurpleAir Sensors and nearest Weather Stations
```{r, map-pa-weather}
# Convert weather stations to a data frame
weather_stations_df <- as.data.frame(st_coordinates(weather_stations))
colnames(weather_stations_df) <- c("wlon", "wlat")
weather_stations_df$weatherstation <- weather_stations$id

# Convert filtered sensors to a data frame
filtered_sensors_df <- as.data.frame(st_coordinates(filtered_sensors))
colnames(filtered_sensors_df) <- c("plon", "plat")
filtered_sensors_df$sensor_index <- filtered_sensors$sensor_index
filtered_sensors_df$weatherstation <- filtered_sensors$weatherstation

# Join filtered sensors and weather stations data frames
result <- left_join(filtered_sensors_df, weather_stations_df, by = "weatherstation")

# Connect sensors with closest weather stations with lines
sensor_coords <- result[, c("plon", "plat")]
names(sensor_coords) <- c("long", "lat")
station_coords <- result[, c("wlon", "wlat")]
names(station_coords) <- c("long", "lat")

# Add lines as geometry
result$geometry <- do.call("c", lapply(seq(nrow(sensor_coords)), function(i) {
  st_sfc(st_linestring(as.matrix(rbind(sensor_coords[i, ], station_coords[i, ]))), crs = 4326)
}))

# Convert the result to a simple feature object
closest_station <- st_as_sf(result)

# Create map views
m1 <- mapview(filtered_sensors, col.regions = "purple", cex = 1)
m2 <- mapview(weather_stations, col.regions = "darkgreen", cex = 5)
m3 <- mapview(closest_station, color = "pink")

# Combine map views
m1 + m2 + m3
```

# PurpleAir Sensors and OSM
## Create Buffers around Purple Air Sensors
```{r, pa-buffers, eval=FALSE}
# buffer radius in meters
buffer = 500
purpleairs_buffers <- st_buffer(filtered_sensors, dist=buffer)
```

```{r}
# intersect keeps original geometry of item, just returns which items overlap
# intersection cuts geometry to be contained by buffer zone (only includes overlapping parts)
# intersection returns both objects joined

# function to get intersections using st_intersects
intersection_osm_buffers <- function(purpleairs_buffers, osm_data) {
  osm_intersections <- st_intersects(osm_data, purpleairs_buffers)
  osm_filtered <- filter(osm_data, purrr::map_lgl(osm_intersections, ~!purrr::is_empty(.x)))
  intersections <- st_intersects(purpleairs_buffers, osm_filtered)

  result <- list()
  for (i in seq_along(intersections)) {
    osm_i <- intersections[[i]]
    for (o in osm_i) {
      osm = osm_filtered[o,]
      sensor = purpleairs_buffers[i,]
      osm$sensor_index <- sensor$sensor_index
      result <- c(result, list(osm))
    }
  }
  result_df <- do.call(rbind, result)
  return(result_df)
}

# roads & purple air intersections
check_time <- system.time({
  roads <- intersection_osm_buffers(purpleairs_buffers, osm_roads)
})
st_write(roads, paste0(preprocessing_directory, "/roads.gpkg"), driver = "GPKG", append=FALSE)

# trees & purple air intersections
check_time <- system.time({
  trees <- intersection_osm_buffers(purpleairs_buffers, osm_trees)
})
st_write(trees, paste0(preprocessing_directory, "/trees.gpkg"), driver = "GPKG", append=FALSE)

# buildings & purple air intersections
check_time <- system.time({
  buildings <- intersection_osm_buffers(purpleairs_buffers, osm_buildings)
})
st_write(buildings, paste0(preprocessing_directory, "/buildings.gpkg"), driver = "GPKG", append=FALSE)

#######
#######
#######

nrow(osm_roads)
nrow(roads)

#######
check_time <- system.time({
  roads_intersections <- st_intersects(osm_roads, purpleairs_buffers)
  roads_filtered <- filter(osm_roads, purrr::map_lgl(roads_intersections, ~!purrr::is_empty(.x)))
})
roads_intersections <- st_intersects(osm_roads, purpleairs_buffers)
roads_filtered <- filter(osm_roads, purrr::map_lgl(roads_intersections, ~!purrr::is_empty(.x)))
nrow(osm_roads)
nrow(roads_filtered)
check_time


# roads <- st_intersection(roads_filtered, purpleairs_buffers)

# buildings & purple air intersections
buildings_intersections <- st_intersects(osm_buildings, purpleairs_buffers)
buildings_filtered <- filter(osm_buildings, purrr::map_lgl(buildings_intersections, ~!purrr::is_empty(.x)))
# buildings <- st_intersection(buildings_filtered, purpleairs_buffers)

# trees & purple air intersections
trees_intersections <- st_intersects(osm_trees, purpleairs_buffers)
trees_filtered <- filter(osm_trees, purrr::map_lgl(trees_intersections, ~!purrr::is_empty(.x)))
# trees <- st_intersection(trees_filtered, purpleairs_buffers)
trees
```

```{r}
crs = 4326
bbox <- c(xmin = -122.47, ymin = 37.76, xmax = -122.44, ymax = 37.74)
bbox_polygon <- st_as_sfc(st_bbox(bbox))
st_crs(bbox_polygon) <- crs
purpleairs_buffers2 <- st_intersection(purpleairs_buffers, bbox_polygon)
mapview(purpleairs_buffers2)

intersections2 <- st_intersects(osm_buildings, bbox_polygon)
buildings2 <- filter(osm_buildings, purrr::map_lgl(intersections2, ~!purrr::is_empty(.x)))

# im trying to use st_intersects to return the joined df of intersections

# METHOD 1
buildings_intersections2 <- st_intersects(purpleairs_buffers2, buildings2)

result <- list()
for (i in seq_along(buildings_intersections2)) {
  buildings_i <- buildings_intersections2[[i]]
  for (b in buildings_i) {
    building = buildings2[b,]
    sensor = purpleairs_buffers2[i,]
    building$sensor_index <- sensor$sensor_index
    result <- c(result, list(building))
  }
}
result_df <- do.call(rbind, result)






result2 <- st_intersection(buildings2, purpleairs_buffers2)

buildings_intersections2 <- st_intersects(purpleairs_buffers2, buildings2)
buildings_filtered2 <- filter(osm_buildings2, purrr::map_lgl(buildings_intersections2, ~!purrr::is_empty(.x)))
```

```{r}
mapview(purpleairs_buffers2)

x1 <- result_2 %>% filter(sensor_index == 37725)
x2 <- result_df %>% filter(sensor_index == 37725)
```

```{r}
# Measure execution time for METHOD 1
method1_time <- system.time({
  buildings_intersections2 <- st_intersects(purpleairs_buffers2, buildings2)
  result <- list()
  for (i in seq_along(buildings_intersections2)) {
    buildings_i <- buildings_intersections2[[i]]
    for (b in buildings_i) {
      building <- buildings2[b, ]
      sensor <- purpleairs_buffers2[i, ]
      building$sensor_index <- sensor$sensor_index
      result <- c(result, list(building))
    }
  }
  result_df <- do.call(rbind, result)
})

# Measure execution time for METHOD 2
method2_time <- system.time({
  result_2 <- st_intersection(purpleairs_buffers2, buildings2)
})

# Compare execution times
method1_time
method2_time
```

```{r}
n <- 10000
purpleair_roads <- list()

for (i in 1:ceiling(nrow(roads_filtered) / n)) {
  cat("\nIteration", i, "of", ceiling(nrow(roads_filtered) / n), "\n")
  start_idx <- (i - 1) * n + 1
  end_idx <- min(i * n, nrow(roads_filtered))

  purpleair_roads_i <- st_intersection(roads_filtered[start_idx:end_idx, ], purpleairs_buffers)

  if (nrow(purpleair_roads_i) > 0)  {
    # Add the results to the list
    purpleair_roads[[i]] <- purpleair_roads_i
  }

}

purpleair_roads <- do.call(rbind, purpleair_roads)


print(nrow(roads_filtered))
print(nrow(osm_roads))
```

### intersection method
```{r, eval=FALSE}
test = osm_buildings[770:780,]
st_is_valid(osm_buildings[770:780,])

is_valid_buildings <- st_is_valid(osm_buildings)
valid_buildings <- buildings[is_valid_buildings, ]
valid_buildings <- st_make_valid(valid_buildings)
valid_buildings <- st_transform(valid_buildings, crs=crs)
purpleair_buildings_i <- st_intersection(valid_buildings[start_idx:end_idx, ], purpleairs_buffers)
```




# Get area of buildings for each PA sensor
```{}
path = '/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/'
purpleair_buildings <- st_read(paste0(path,"purpleair_buildings.shp"))

purpleair_building_areas <- purpleair_buildings %>%
  group_by(sensr_d, type) %>%
  summarize(total_area = sum(st_area(geometry)))

st_write(purpleair_building_areas, "/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/purpleair_building_areas.shp", append=FALSE)

```

########################################################
########################################################
########################################################
# Input dates for the month you want
```{}
year = 2019
month = 9
```

# format dates for filenames
```{}
# Create a date object for the first & last day of the month
first_day <- make_date(year, month, 1)
last_day <- ceiling_date(make_date(year, month, 1), "month") - days(1)

# Format the dates as strings in the desired format
purpleairformat <- paste0(format(first_day, "%Y-%m-01"), "_", format(last_day, "%Y-%m-%d"))
uberformat <- sprintf("%d-%d", year, month)
```

```{r}
# nrow(osm_buildings) : 2,652,364
building_counts <- osm_buildings %>% 
  count(building) %>% 
  arrange(desc(n))

building_counts
```


```{r}

```


```{r}

```

```{r}

```

```{r}
# Convert weather data frame to an sf object
weather_sf <- st_as_sf(weather, coords=c("lon", "lat"), crs = crs)
```


#########################################
# Buildings and PurpleAir Intersections #
#########################################

```{r, eval=FALSE}
path = '/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/'
purpleairs_buffers <- st_read(paste0(path,'purpleairs_buffers.shp'))
path = '/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/shape/'
buildings <- st_read(paste0(path,"buildings.shp"))

# buildings & purple air intersections
is_valid_buildings <- st_is_valid(buildings)
valid_buildings <- buildings[is_valid_buildings, ]
valid_buildings <- st_make_valid(valid_buildings)
valid_buildings <- st_transform(valid_buildings, crs=crs)


n <- 10000
purpleair_buildings <- list()

for (i in 1:ceiling(nrow(valid_buildings) / n)) {
  cat("\nIteration", i, "of", ceiling(nrow(valid_buildings) / n), "\n")
  start_idx <- (i - 1) * n + 1
  end_idx <- min(i * n, nrow(valid_buildings))

  purpleair_buildings_i <- st_intersection(valid_buildings[start_idx:end_idx, ], purpleairs_buffers)

  if (nrow(purpleair_buildings_i) > 0)  {
    # Add the results to the list
    purpleair_buildings[[i]] <- purpleair_buildings_i
  }

}

purpleair_buildings <- do.call(rbind, purpleair_buildings)
# cant save it to shapefile if osm_id is numeric (??)
purpleair_buildings$osm_id <- as.character(purpleair_buildings$osm_id)

st_write(purpleair_buildings, "/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/purpleair_buildings.shp", append=FALSE)
```

# Get area of buildings for each PA sensor
```{}
path = '/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/'
purpleair_buildings <- st_read(paste0(path,"purpleair_buildings.shp"))

purpleair_building_areas <- purpleair_buildings %>%
  group_by(sensr_d, type) %>%
  summarize(total_area = sum(st_area(geometry)))

st_write(purpleair_building_areas, "/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/purpleair_building_areas.shp", append=FALSE)

```




```{r}

purpleair_sensors <- purpleair_sensors %>% 
  filter(sensor_index %in% unique(purpleair_data$sensor_index))

```

####################################################
############################################
# purpleair outlier stuff #
############################################
```{r, eval=FALSE}
# absolute difference threshold
threshold <- 50

# Filter out rows where absolute difference is greater than threshold
purpleair_points <- purpleair_points %>%
  filter(abs(pm2.5_atm_a - pm2.5_atm_b) <= threshold) %>%
  filter(pm2.5_atm_a<2000) %>%
  filter(pm2.5_atm_b<2000)

avg_pm25 <- purpleair_points %>%
  group_by(sensor_id) %>%
  summarize(avg_pm25 = mean(pm2.5_atm))

# rm(purpleair_points)
# Define the intervals and corresponding colors
intervals <- c(0, 12, 35.4, 55.4, Inf)
AQI <- c("Good", "Moderate", "Unhealthy for Sensitive Groups", "BAD")

# Create a new column with color intervals
avg_pm25$AQI <- cut(avg_pm25$avg_pm25, breaks = intervals, labels = AQI, include.lowest = TRUE)

# Plot the average PM2.5 for each sensor
map <- mapview(avg_pm25, zcol = "AQI", legend = TRUE)
map

custom_colors <- c("green", "yellow", "orange", "red")

# Create a new column with color intervals
avg_pm25$AQI <- cut(avg_pm25$avg_pm25, breaks = intervals, labels = AQI, include.lowest = TRUE)

# Plot the average PM2.5 for each sensor with custom colors
map <- mapview(avg_pm25, zcol = "AQI", col.regions = custom_colors, legend = TRUE)
map
```

############################################
# uber stuff #
############################################
```{r, eval=FALSE}
# Convert the OSM way IDs in the Uber speeds data to character type
uber_data$osm_way_id <- as.character(uber_data$osm_way_id)
```

```{r, eval=FALSE}
# Change highway column to factor (to have ordered levels)
# https://wiki.openstreetmap.org/wiki/Map_features#Highway

uber_data$highway <- factor(uber_data$highway,
                               levels=c("motorway", "trunk", "primary", "secondary", "tertiary",
                                        "construction", "unclassified", "residential",
                                        "motorway_link", "trunk_link", "primary_link", "secondary_link",
                                        "tertiary_link", "service", "pedestrian", "cycleway"))

uber_data <- uber_data %>% select(utc_timestamp, osm_way_id, speed_mph_mean, highway)
```

```{r, eval=FALSE}
uber_data <- uber_data %>%
  filter(utc_timestamp >= as.POSIXct("2019-09-01 00:00:00") &
         utc_timestamp < as.POSIXct("2019-09-02 00:00:00"))

purpleair <- purpleair %>%
  filter(time_stamp >= as.POSIXct("2019-09-01 00:00:00") &
         time_stamp < as.POSIXct("2019-09-02 00:00:00"))

```

############################################
# merging stuff #
############################################
```{}
osm_uber_sf <- sanfrangrid_roads[sanfrangrid_roads$osm_id %in% unique(uber_data$osm_way_id), ]
rm(sanfrangrid_roads)
osm_uber_roads <- merge(osm_uber_sf, uber_data, by.x = "osm_id", by.y = "osm_way_id", all.x = TRUE)
rm(uber_data)
```

```{r, eval=FALSE}
# Plot purple airs map
map_sf <- mapview(purpleair_sf, col.regions = "purple", col = "purple", cex = 0.1, legend = FALSE)

# Add uber layer
map_sf <- map_sf + mapview(osm_uber_sf, col.regions="lightblue", col="lightblue")

# View map
map_sf

# Save map as html
mapshot(map_sf, url = '/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/map_sf.html')
```

############################################
# Length of Roads around PurpleAirs #
############################################

```{r, eval=FALSE}
path = '/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/'
purpleair_uber_roads <- st_read(paste0(path,'purpleair_uber_roads.shp'))

purpleair_road_length <- purpleair_uber_roads %>%
  group_by(sensr_d, type) %>%
  summarize(road_length = sum(st_length(geometry)))

st_write(purpleair_road_length, "/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/purpleair_road_length.shp", append=FALSE)
```


#########################################
# Uber congestion and free flow speeds #
#########################################

```{r, eval=FALSE}
uber_data <- uber_data %>%
  group_by(osm_way_id) %>%
  mutate(free_flow_speed = quantile(speed_mph_mean, 0.95)) %>%
  ungroup()
uber_data$congestion_ratio <- uber_data$speed_mph_mean / uber_data$free_flow_speed

speed_map <- purpleair_roads %>% left_join(uber_data, by = c("osm_id" = "osm_way_id"))
palette3 <- colorRampPalette(c("red", "green"))

map <- mapview(purpleairs, col.regions = "purple", legend = FALSE, layer.name = "PurpleAir Sensors")
# (1 = free flow speed, <1 = congestion, >1 = faster speed)
# map1 <- map + mapview(speed_map, zcol = "congestion_ratio",
#                       col.regions = palette3, col = palette3, legend.lab = "Congestion Ratio")
map1 <- map + mapview(speed_map, zcol = "free_flow_speed",
                      col.regions = palette3, col = palette3,
                      legend.lab = "Free Flow Speed", layer.name = "Free Flow Speed")
map1
```

#########################################
# AQI #
#########################################

```{r, eval=FALSE}
# Group by sensor_id and calculate the average pm2.5_atm for each sensor
avg_pm25 <- purpleair_points %>%
  group_by(sensor_id) %>%
  summarize(avg_pm25 = mean(pm2.5_atm, na.rm = TRUE))

# Define the intervals and corresponding colors
intervals <- c(0, 12, 35.4, 55.4, Inf)
AQI <- c("Good", "Moderate", "Unhealthy for Sensitive Groups", "BAD")

# Create a new column with color intervals
avg_pm25$AQI <- cut(avg_pm25$avg_pm25, breaks = intervals, labels = AQI, include.lowest = TRUE)

# Plot the average PM2.5 for each sensor
map <- mapview(avg_pm25, zcol = "AQI", legend = TRUE)
map

custom_colors <- c("green", "yellow", "orange", "red")

# Create a new column with color intervals
avg_pm25$AQI <- cut(avg_pm25$avg_pm25, breaks = intervals, labels = AQI, include.lowest = TRUE)

# Plot the average PM2.5 for each sensor with custom colors
map <- mapview(avg_pm25, zcol = "AQI", col.regions = custom_colors, legend = TRUE)
map
# Plot the average pm2.5_atm for each sensor on a map
# mapview(avg_pm25_by_sensor, zcol = "avg_pm25", legend = TRUE)
```

#########################################
# 1 day hourly sensor plot #
#########################################

```{r, eval=FALSE}

sensor_with_hourly_readings <- purpleair_points %>%
  group_by(sensor_id) %>%
  filter(n_distinct(hour(time_stamp)) == 24) %>%
  slice(1)  # Select the first sensor that meets the condition

# Plot the daily trend for the selected sensor
ggplot(sensor_with_hourly_readings, aes(x = hour(time_stamp), y = pm2.5_atm)) +
  geom_line() +
  labs(x = "Hour of the Day", y = "PM2.5 ATM", title = "Daily Trend of PM2.5 for Selected Sensor") +
  theme_minimal()

```

####################################################
####################################################
####################################################
########################################################################################################
####################################################
####################################################
########################################################################################################
####################################################
####################################################
########################################################################################################
####################################################
####################################################
########################################################################################################
####################################################
####################################################
########################################################################################################
####################################################
####################################################
####################################################

```{r, eval=FALSE}
# Store the URL of the API endpoint to request data from for PurpleAir air quality sensors
all <- "https://api.purpleair.com/v1/sensors?fields=latitude%2C%20longitude%2C%20date_created%2C%20last_seen"

# Define the header for the HTTP request to the API, including the API key and Accept content type
header = c('X-API-Key' = auth_key,'Accept' = "application/json")

# Get Purple Air data using the following steps
# Make the HTTP request to the PurpleAir API using the GET function from the httr library
# Convert the raw content returned by the API into a character string
# Convert the character string into a JSON object
# Extract the "data" element from the JSON object and convert it to a data frame
result <- GET(all, add_headers(header))
raw <- rawToChar(result$content)
json <- jsonlite::fromJSON(raw)
pa <- as.data.frame(json$data)

# Rename the columns of the PurpleAir data frame
colnames(pa) <- c("sensor_id","date_created", "last_seen", "lat", "lon")

pa <- pa %>% select(sensor_id,lat,lon)

pa <- pa %>% na.omit()

pa <- pa %>% filter(sensor_id %in% unique(purpleair$sensor_id))

dt <- st_as_sf(pa, coords=c("lon", "lat"), crs = crs)

rm(result)
rm(json)
rm(pa)
```

```{r, eval=FALSE}
purpleair_sf <- dt[dt$sensor_id %in% unique(purpleair$sensor_id), ]
rm(dt)
# purpleair_points <- merge(purpleair_sf, purpleair, by.x = "sensor_id", by.y = "sensor_id", all.x = TRUE)
# rm(purpleair)
```

```{r, eval=FALSE}
# Save shapefile
# st_write(purpleairs_buffers, paste0(path,'purpleairs_buffers.shp'))

# purpleairs_buffers <- st_read(paste0(path,'purpleairs_buffers.shp'))

# Plot purple airs map
# alpha: line opacity
# alpha.regions: fill opacity
map_uber_pa <- mapview(purpleairs_buffers, col.regions="purple", col="purple", alpha=1, alpha.regions=0.2)

# Add uber layer (showing highway type)
map_uber_pa <- map_uber_pa + mapview(osm_uber_sf,zcol="highway", legend=TRUE)

# View map
map_uber_pa

# Save map as html
url2 = paste0(path,'map_uber_pa.html')
mapshot(map_uber_pa, url = url2)
```

```{r, eval=FALSE}
map_uber_pa
```




# Get intersections of Roads & PurpleAir
```{r, eval=FALSE}
# # use downloaded osm data
# path = '/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/shape/'
# roads <- st_read(paste0(path,"roads.shp"))
#
# # keep roads that are in uber data
# uber_roads_osm <- roads[roads$osm_id %in% unique(uber_data$osm_way_id), ]
#
# # keep relevent columns
# uber_roads_osm <- uber_roads_osm %>% select(osm_id, name, type)
#
# # number of osm ways: 13709
# length(unique(uber_roads_osm$osm_id))
# # number of uber ways: 71603 (larger than SF area)
# length(unique(uber_data$osm_way_id))
#
# # convert selected_ways to sf object
# uber_roads_osm <- st_transform(uber_roads_osm, crs = crs)
#
# path = '/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/'
# purpleairs_buffers <- st_read(paste0(path,'purpleairs_buffers.shp'))


# intersection between purpleair buffers and uber roads
# purpleair_uber_roads <- st_intersection(osm_uber_roads, purpleairs_buffers)
purpleair_uber_roads <- st_intersection(osm_uber_sf, purpleairs_buffers)

# save shapefile
st_write(purpleair_uber_roads, "/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/purpleair_uber_roads.shp", append=FALSE)
```

# Map of PurpleAir and Roads intersections
```{r, eval=FALSE}
path = '/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/'
purpleair_uber_roads <- st_read(paste0(path,'purpleair_uber_roads.shp'))
```

```{r, eval=FALSE}
mapview(purpleair_uber_roads)
```

# Length of Roads around PurpleAirs
```{r, eval=FALSE}
path = '/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/'
purpleair_uber_roads <- st_read(paste0(path,'purpleair_uber_roads.shp'))

purpleair_road_length <- purpleair_uber_roads %>%
  group_by(sensr_d, type) %>%
  summarize(road_length = sum(st_length(geometry)))

st_write(purpleair_road_length, "/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/purpleair_road_length.shp", append=FALSE)
```


# Map of PurpleAir and Buildings intersections

```{r, eval=FALSE}
path = '/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/'
purpleair_buildings <- st_read(paste0(path,"purpleair_buildings.shp"))

mapview(purpleair_buildings)
```



#############################################
# Use downloaded OSM data for San Fransisco #
#############################################
```{}
# https://download.bbbike.org/osm/bbbike/SanFrancisco/

path = '/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/shape/'


# read shapefiles
buildings <- st_read(paste0(path,"buildings.shp"))
landuse <- st_read(paste0(path,"landuse.shp"))
natural <- st_read(paste0(path,"natural.shp"))
places <- st_read(paste0(path,"places.shp"))
points <- st_read(paste0(path,"points.shp"))
railways <- st_read(paste0(path,"railways.shp"))
roads <- st_read(paste0(path,"roads.shp"))
waterways <- st_read(paste0(path,"waterways.shp"))

mapview(buildings) # buildings to get area from
mapview(landuse)
mapview(natural) # parks/water...
mapview(places)
mapview(points)
mapview(railways) # get railways and length
mapview(roads) # exlude footways and paths? by road type?
mapview(waterways)


```





# Get Buildings & PurpleAir intersections
```{r, eval=FALSE}
# use downloaded osm data
path = '/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/shape/'
buildings <- st_read(paste0(path,"buildings.shp"))

# read purple air buffers
path = '/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/'
purpleairs_buffers <- st_read(paste0(path,'purpleairs_buffers.shp'))

# intersection between purpleair buffers and san fran buildings
is_valid_buildings <- st_is_valid(buildings)
valid_buildings <- buildings[is_valid_buildings, ]
valid_buildings <- st_make_valid(valid_buildings)
purpleair_buildings <- st_intersection(valid_buildings, purpleairs_buffers)
mapview(purpleair_buildings)
purpleair_buildings <- st_intersection(buildings, purpleairs_buffers)

# save shapefile
st_write(purpleair_uber_roads, "/Users/heba/Desktop/Uni/Lim Lab/uber_purpleair/purpleair_uber_roads.shp", append=FALSE)

```


```{r, eval=FALSE}
path <- "/Users/heba/Desktop/Uni/Lim Lab/OSM"

# read roads file
output_file <- file.path(path, "grid238_roads_osm.shp")
sanfrancell_roads <- st_read(output_file)

# read buildings file
output_file <- file.path(path, "grid238_buildings_osm.gpkg")
sanfrancell_buildings <- st_read(output_file)

# read trees file
output_file <- file.path(path, "grid238_trees_osm.gpkg")
sanfrancell_trees <- st_read(output_file)
```

```{r, eval=FALSE}
osm_uber_sf <- sanfrancell_roads[sanfrancell_roads$osm_id %in% unique(uber_data$osm_way_id), ]
rm(sanfrancell_roads)
# osm_uber_roads <- merge(osm_uber_sf, uber_data, by.x = "osm_id", by.y = "osm_way_id", all.x = TRUE)
# rm(uber_data)

osm_uber_roads <- merge(sanfrancell_roads, uber_data, by.x = "osm_id", by.y = "osm_way_id", all.x = TRUE)
```

```{r, eval=FALSE}
# tiny san fran area
# -122.4 37.742 -122.463 37.78
bbox <- c(left = -122.463, bottom = 37.742, right = -122.4, top = 37.78)
# bbox <- c(left = -122.495663, bottom = 37.714958, right = -122.399274, top = 37.787837)
x = list(rbind(c(bbox["left"],bbox["bottom"]),
               c(bbox["left"],bbox["top"]),
               c(bbox["right"],bbox["top"]),
               c(bbox["right"],bbox["bottom"]),
               c(bbox["left"],bbox["bottom"])))

# Create a polygon for san fran area
bbox_sf <- st_polygon(x)

# convert to sf object
crs = 4326
bbox_sf <- st_sfc(bbox_sf, crs=crs)
```

```{r, eval=FALSE}
osm_uber_sf2 <- st_intersection(osm_uber_sf, bbox_sf)
purpleairs_buffers2 <- st_intersection(purpleairs_buffers, bbox_sf)
sanfrancell_trees2 <- st_intersection(sanfrancell_trees, bbox_sf)
purpleairs <- st_intersection(purpleair_sf, bbox_sf)

purpleair_roads <- st_intersection(osm_uber_sf2, purpleairs_buffers2)
purpleair_trees <- st_intersection(sanfrancell_trees2, purpleairs_buffers2)

sanfrancell_buildings2 <- st_intersection(sanfrancell_buildings, bbox_sf)
purpleair_buildings <- st_intersection(sanfrancell_buildings2, purpleairs_buffers2)
purpleair_buildingsss <- purpleair_buildings %>% select(building)
```

```{r, eval=FALSE}
mapview(purpleairs_buffers2)
```



```{r, eval=FALSE}
# map1 <- map + mapview(speed_map, zcol = "congestion_ratio",
#                       col.regions = palette3, col = palette3,
#                       legend.lab = "Congestion Ratio", layer.name = "Congestion Ratio")
# map1
```
```{r, eval=FALSE}
map2 <- mapview(purpleair_buildingsss, layer.name = "Buildings", col.regions = "grey", legend = FALSE)
map2
```

```{r, eval=FALSE}
ggplot(purpleair_buildingsss)+geom_sf()
```

```{r, eval=FALSE}
map3 <- mapview(purpleair_trees, col.regions = "green",cex=3, legend = FALSE, layer.name = "Trees")
map1 + map2 + map3
```

```{r, eval=FALSE}

```

```{r, eval=FALSE}
map5 <- mapview(speed_map, zcol = "congestion_ratio", col.regions = palette3, col = palette3)
map5
```

