---
title: "Download OSM data"
output:
  html_document:
    df_print: paged
---

```{r}
suppressPackageStartupMessages({
  library(dplyr) # For data manipulation
  library(sf) # For working with spatial data
  library(mapview) # For interactive maps
  library(osmdata) # Open Street Map
  library(data.table)
  library(ggplot2)
})
```

```{r, setup, include=FALSE}
knitr::opts_knit$set(root.dir = '/Users/heba/Desktop/Uni/Lim Lab/OSM')
```

## Bounding box of San Francisco and surrounding areas
```{r san-fran-bounding-box}
# greater san fran area
bbox <- c(left = -123.8, bottom = 36.9, right = -121.0, top = 39.0)

x = list(rbind(c(bbox["left"],bbox["bottom"]),
               c(bbox["left"],bbox["top"]),
               c(bbox["right"],bbox["top"]),
               c(bbox["right"],bbox["bottom"]),
               c(bbox["left"],bbox["bottom"])))

# Create a polygon for san fran area
bbox_sf <- st_polygon(x)

# convert to sf object
crs = 4326
bbox_sf <- st_sfc(bbox_sf, crs=crs)

# view map
mapview(bbox_sf)
```

# Split map into smaller areas
```{r create-grid}
# make polygon into grid with cell size 0.1 x 0.1
grid <- st_make_grid(bbox_sf, cellsize = c(0.1,0.1))

grid_sf <- st_sf(geometry = grid)

# Display map of grid
mapview(grid_sf)
```

# Download roads for each grid cell
```{r download-road-grid, eval=FALSE}
# Loop through each location to get the bounding box and OSM data
for (i in 1:length(grid)) {
  print(i)
  
  output_name <- paste0('grid',i)
  
  osm <- opq(bbox = grid[i]) %>%
    add_osm_feature(key = 'highway') %>%
    osmdata_sf()
  
  # if cell is on empty location skip it
  if (is.null(osm$osm_lines)) {
    next
  }
  
  # Select only the columns you want to keep (if any col doesnt exist fill with NA)
  # if column osm_id is missing fill it with rownames
  if(!"osm_id" %in% names(osm$osm_lines)) {
    osm$osm_lines$osm_id <- rownames(osm$osm_lines)
  }
  # if column name is missing fill it with NA
  if(!"name" %in% names(osm$osm_lines)) {
    osm$osm_lines$name <- NA
  }  
  # if column highway is missing fill it with NA
  if(!"highway" %in% names(osm$osm_lines)) {
    osm$osm_lines$highway <- NA
  }  
  # if column lanes is missing fill it with NA
  if(!"lanes" %in% names(osm$osm_lines)) {
    osm$osm_lines$lanes <- NA
  }
  # if column maxspeed is missing fill it with NA
  if(!"maxspeed" %in% names(osm$osm_lines)) {
    osm$osm_lines$maxspeed <- NA
  }
  
  selected_columns <- osm$osm_lines %>% select(osm_id, name, highway, lanes, maxspeed)

  # Create an sf object
  sf_obj <- st_as_sf(selected_columns)
  
  # Save the sf object as a shapefile
  st_write(sf_obj, paste0(output_name, "_roads_osm.shp"), driver = "GPKG", append=FALSE)
}
```

## Read each grid roads and save to one file
```{r save-road-grid-to-one-file, eval=FALSE}
# Get a list of file paths
file_paths <- list.files(pattern = "^grid.*_roads_osm\\.shp$", full.names = TRUE)

# Read all shapefiles into a list
sf_list <- lapply(file_paths, st_read)

# Merge the spatial objects
merged_sf <- do.call(rbind, sf_list)

# # Remove duplicates based on the 'osm_id' column
# merged_sf <- merged_sf %>% distinct(osm_id, .keep_all = TRUE)

# Write the merged spatial object to a new shapefile
st_write(merged_sf, "sanfrangrid_roads_osm.shp", driver = "GPKG", append=FALSE)
```

# Download buildings for each grid cell
```{r download-building-grid, eval=FALSE}
# Loop through each location to get the bounding box and OSM data
for (i in 1:length(grid)) {
  print(i)
  
  output_name <- paste0('grid',i)
  
  osm <- opq(bbox = grid[i]) %>%
    add_osm_feature(key = 'building') %>%
    osmdata_sf()
  
  # if cell was on an empty location
  if (is.null(osm$osm_polygons) || nrow(osm$osm_polygons) == 0) {
    next
  }
  
  # Select only the columns you want to keep (if any col doesnt exist fill with NA)
  
  # if column osm_id is missing fill it with rownames
  if(!"osm_id" %in% names(osm$osm_polygons)) {
    osm$osm_polygons$osm_id <- rownames(osm$osm_polygons)
  }
  # if column name is missing fill it with NA
  if(!"name" %in% names(osm$osm_polygons)) {
    osm$osm_polygons$name <- NA
  }  
  # if column building is missing fill it with NA
  if(!"building" %in% names(osm$osm_polygons)) {
    osm$osm_polygons$building <- NA
  }  
  # if column amenity is missing fill it with NA
  if(!"amenity" %in% names(osm$osm_polygons)) {
    osm$osm_polygons$amenity <- NA
  }
  
  selected_columns <- osm$osm_polygons %>% select(osm_id, name, building, amenity)

  # Create an sf object
  sf_obj <- st_as_sf(selected_columns)
  
  # Save the sf object as a shapefile
  st_write(sf_obj, paste0(output_name, "_buildings_osm.gpkg"), driver = "GPKG", append=FALSE)
}
```

## Read smaller building grid areas and save to one file
```{r save-building-grid-to-one-file, eval=FALSE}
# Get a list of file paths
file_paths <- list.files(pattern = "^grid.*_buildings_osm\\.gpkg$", full.names = TRUE)

# Read all shapefiles into a list
sf_list <- lapply(file_paths, st_read)

# Merge the spatial objects
merged_sf <- do.call(rbind, sf_list)

# # Remove duplicates based on the 'osm_id' column
# merged_sf <- merged_sf %>% distinct(osm_id, .keep_all = TRUE)

# Write the merged spatial object to a new shapefile
st_write(merged_sf, "sanfrangrid_buildings_osm.gpkg", driver = "GPKG", append=FALSE)
```

# Download trees for each grid cell
```{r download-trees-grid, eval=FALSE}
# Loop through each location to get the bounding box and OSM data
for (i in 1:length(grid)) {
  print(i)
  
  output_name <- paste0('grid',i)
  
  osm <- opq(bbox = grid[i]) %>%
    add_osm_feature(key = 'natural') %>%
    osmdata_sf()
  
  tree_points <- osm$osm_points[!is.na(osm$osm_points$natural), ]
  tree_points <- tree_points[tree_points$natural == "tree", ]
  
  # if cell was on an empty location
  if (is.null(tree_points) || nrow(tree_points) == 0) {
    next
  }
  
  # Select only the columns you want to keep (if any col doesnt exist fill with NA)
  
  # if column osm_id is missing fill it with rownames
  if(!"osm_id" %in% names(tree_points)) {
    tree_points$osm_id <- rownames(tree_points)
  }
  
  selected_columns <- tree_points %>% select(osm_id)

  # Create an sf object
  sf_obj <- st_as_sf(selected_columns)
  
  # Save the sf object as a shapefile
  st_write(sf_obj, paste0(output_name, "_trees_osm.gpkg"), driver = "GPKG", append=FALSE)
}
```

## Read smaller trees grid areas and save to one file
```{r save-trees-grid-to-one-file, eval=FALSE}
# Get a list of file paths
file_paths <- list.files(pattern = "^grid.*_trees_osm\\.gpkg$", full.names = TRUE)

# Read all shapefiles into a list
sf_list <- lapply(file_paths, st_read)

# Merge the spatial objects
merged_sf <- do.call(rbind, sf_list)

# Write the merged spatial object to a new shapefile
st_write(merged_sf, "sanfrangrid_trees_osm.gpkg", driver = "GPKG", append=FALSE)
```

## Read merged osm files
```{r read-buildings-roads-trees, message=FALSE, warning=FALSE}
# read roads file
sanfrangrid_roads <- st_read("sanfrangrid_roads_osm.shp", quiet = TRUE)

# read buildings file
sanfrangrid_buildings <- st_read("sanfrangrid_buildings_osm.gpkg", quiet = TRUE)

# read trees file
sanfrangrid_trees <- st_read("sanfrangrid_trees_osm.gpkg", quiet = TRUE)
```

## Plot roads
```{r, plot-roads}
ggplot(sanfrangrid_roads) + geom_sf()
```

## Plot buildings
```{r, plot-buildings}
ggplot(sanfrangrid_buildings) + geom_sf()
```

## Plot trees
```{r, plot-trees}
ggplot(sanfrangrid_trees) + geom_sf()
```

# Read roads and buildings for cell 238
```{r read-cell-238-files, message=FALSE, warning=FALSE}
# read roads file
sanfrancell_roads <- st_read("grid238_roads_osm.shp", quiet = TRUE)

# read buildings file
sanfrancell_buildings <- st_read("grid238_buildings_osm.gpkg", quiet = TRUE)

# read trees file
sanfrancell_trees <- st_read("grid238_trees_osm.gpkg", quiet = TRUE)
```

## Map of San Fran roads
```{r mapview-roads}
mapview(sanfrancell_roads, layer.name = "Roads",  zcol = "highway")
```

## Map of San Fran buildings
```{r mapview-buildings}
mapview(sanfrancell_buildings, layer.name = "Buildings", zcol = "building")
```

## Map of San Fran trees
```{r mapview-trees}
mapview(sanfrancell_trees, col.regions = "green", legend = FALSE, layer.name = "Trees")
```