---
title: "Download PurpleAir Data"
output: github_document
---

```{r, install-pa-package, eval=FALSE, include=FALSE}
# # Run to install purpleAirAPI package
# library(devtools)
# suppressMessages({devtools::install_github("heba-razzak/purpleAirAPI")})
```

```{r, setup, include=FALSE}
api_key <- readr::read_file("inputs/purpleair_key.txt")
purpleair_directory <- readr::read_file("inputs/purpleair_directory.txt")
preprocessing_directory <- readr::read_file("inputs/preprocessing_directory.txt")
```

## Load required libraries
```{r, load-libraries, message = FALSE, warning = FALSE}
library(dplyr)      # Data manipulation
library(sf)         # Spatial data manipulation
library(ggplot2)    # Data visualization
library(lubridate)  # Working with dates
library(tigris)     # Counties map data
library(purpleAirAPI) # Download PurpleAir Data
```

```{r, include = FALSE}
# CRS (coordinate reference system)
crs = 4326
```

## Download purple air sensor id, lat, lon, date created, last seen
```{r, download-purpleair-sensors}
# Download sensor data
pa <- getPurpleairSensors(apiReadKey = api_key) %>% na.omit()

# Convert the PurpleAir data frame to an sf object
pa_sf <- st_as_sf(pa, coords=c("longitude", "latitude"), crs = crs)
```

## Map PurpleAir sensors in Bay Area
```{r, sensors-bayarea, message = FALSE, warning = FALSE}
# Define bounding box for the Bay Area
bbox <- c(xmin = -123.8, ymin = 36.9, xmax = -121.0, ymax = 39.0)
bbox_sf <- st_as_sfc(st_bbox(bbox))
st_crs(bbox_sf) <- crs

# Filter sensors within bounding box
purpleairs_sf <- st_intersection(pa_sf, bbox_sf)

# Load California county boundaries
ca <- counties("California", cb = TRUE)

# Plot the sensors
ggplot() + 
  geom_sf(data = ca, color = "black", fill = "antiquewhite", size = 0.25) +
  geom_sf(data = purpleairs_sf, color = "purple", size = 0.1) +
  coord_sf(xlim = c(-123.8, -121.0), ylim = c(36.9, 39.0)) +
  theme(panel.background = element_rect(fill = "aliceblue")) + 
  labs(title = "PurpleAir Sensors in the Bay Area", x = "Longitude", y = "Latitude")
```

## Set inputs for PurpleAir data
```{r, inputs-purple-air}
fields <- c("pm2.5_atm", "pm2.5_atm_a", "pm2.5_atm_b", "rssi", "uptime",
            "pa_latency", "memory", "humidity", "temperature",
            "pressure", "voc", "analog_input")
average <- "60"

# Date range for data download
start_date <- as.Date("2018-01-01")
end_date <- as.Date("2018-01-01")
```

```{r, download-data}
start_time <- Sys.time()

filtered_sensors_sf <- purpleairs_sf %>% 
  filter(last_seen >= start_date) %>% 
  filter(date_created <= end_date)

sensor_ids <- unique(filtered_sensors_sf$sensor_index)

# Get PurpleAir data
purpleair_data <- getSensorHistory(
  sensorIndex = sensor_ids,
  apiReadKey = api_key,
  startDate = start_date,
  endDate = end_date,
  average = average,
  fields = fields
)

# Save to CSV file
write.csv(
  purpleair_data,
  file = paste0(
    purpleair_directory, "/purpleair_", start_date, "_", end_date, ".csv"),
  row.names = FALSE)
```

```{r, map-sensors, include = FALSE}
## Map PurpleAir Sensors Bay Area (2018-2019)

# Read purple air data
# purple_air_data <- read.csv(paste0(purpleair_directory, "/purple_air_2018-01-01-2019-12-31.csv"))
# # purple_air_data <- read.csv(paste0(purpleair_directory, "/purple_air_2018-2019.csv"))

purpleairs_sf_filtered <- purpleairs_sf %>% 
  filter(sensor_index %in% unique(purple_air_data$sensor_index)) %>% 
  select(sensor_index)

ca <- counties("California", cb = TRUE)

ggplot() + 
  geom_sf(data = ca, color="black", fill="antiquewhite", size=0.25) +
  geom_sf(data = purpleairs_sf_filtered, color = "purple", size = 0.1) +
  coord_sf(xlim = c(-123.8, -121.0), ylim = c(36.9, 39.0)) +
  theme(panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("PurpleAir in San Francisco 2018-2019") 
```

```{r, num-sensors, include = FALSE}
## Number of Sensors 2018-2019

cat("Total number of sensors: ", length(unique(purpleairs_sf_filtered$sensor_index)))
```

```{r, monthly-sensors, include = FALSE}
## Plot Sensors by Month

# Add column for month
purple_air_data$month <- format(as.Date(purple_air_data$time_stamp), "%Y-%m")

# Sensors for each month
monthly_sensors <- purple_air_data %>% select(month, sensor_index) %>% distinct()

sensor_counts <- monthly_sensors %>%
  group_by(month) %>%
  summarise(sensor_count = n_distinct(sensor_index))

ggplot(sensor_counts, aes(x = month, y = sensor_count)) +
  geom_bar(stat = "identity", fill = "lavender", color = "black") +
  labs(title = "Number of PurpleAir Sensors per Month",
       x = "Month",
       y = "Number of Sensors") +
  scale_y_continuous(breaks = seq(0, max(sensor_counts$sensor_count) + 100, by = 100)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
