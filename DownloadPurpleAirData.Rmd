---
title: "Download PurpleAir Data"
output: github_document
---

```{r, install-pa-package, eval=FALSE, echo=FALSE}
# Run to install purpleAirAPI package
suppressMessages({devtools::install_github("heba-razzak/purpleAirAPI")})
```

```{r, setup, echo=FALSE}
api_key <- readr::read_file("inputs/purpleair_key.txt")
purpleair_directory <- readr::read_file("inputs/purpleair_directory.txt")
preprocessing_directory <- readr::read_file("inputs/preprocessing_directory.txt")
```

## Load required libraries

```{r, load-libraries, message = FALSE, warning = FALSE}
library(dplyr)        # Data manipulation
library(sf)           # Spatial data manipulation
library(ggplot2)      # Data visualization
library(lubridate)    # Working with dates
library(tigris)       # Counties map data
library(kableExtra)   # Printing formatted tables
library(purpleAirAPI) # Download PurpleAir Data
library(DataOverviewR)
```

```{r, echo = FALSE}
# CRS (coordinate reference system)
crs = 4326
```

## Download PurpleAir Sensor Data
### Fields: sensor_index, date_created, last_seen, latitude, longitude

PurpleAir Documentation:\
[Sensor fields](https://api.purpleair.com/#api-sensors-get-sensor-data)\
[Field Descriptions](https://community.purpleair.com/t/api-history-fields-descriptions/4652)

```{r, echo = FALSE, eval = FALSE}
# Documentation for purpleAir sensors function
?purpleAirAPI::getPurpleairSensors
```

```{r, download-purpleair-sensors}
# Download sensor data
pa <- getPurpleairSensors(apiReadKey = api_key, 
                          fields = c("latitude", "longitude", "date_created", "last_seen", "location_type")) %>% na.omit()
```

### PurpleAir Sensor Data
```{r, view-pa-sensors, echo = FALSE}
knitr::kable(head(pa, 3),
             row.names = FALSE,
             format = "markdown")
```

## Convert PurpleAir data frame to shapefile

```{r, pasensors-shapefile}
# Convert the PurpleAir data frame to an sf object
pa_sf <- st_as_sf(pa, coords=c("longitude", "latitude"), crs = crs)
```

### PurpleAir Sensor Shapefile

```{r, view-pasensors-shapefile, echo = FALSE}
knitr::kable(head(pa_sf, 3),
             row.names = FALSE,
             format = "markdown")
```

```{r, sensor-data-dict, echo = FALSE}
desc <- data_description(pa_sf, 
                         var_desc = c("The sensor's index. Can be used to add a sensor to a group or view its details.",
                                         "The UNIX time stamp from when the device was created.",
                                         "The UNIX time stamp of the last time the server received data from the device.",
                                         "The location type. Possible values are: 0 = Outside or 1 = Inside.",
                                         "Geometry"))
data_dictionary(pa_sf, data_title = "PurpleAir Sensors Shapefile", descriptions = desc, hide = c("top_n", "NA_Percentage"))
```

## Map PurpleAir sensors in Bay Area

Filter sensors within a bounding box of the bay area

```{r, sensors-bayarea, message = FALSE, warning = FALSE, results = "hide"}
# Define bounding box for the Bay Area
bbox <- c(xmin = -123.8, ymin = 36.9, xmax = -121.0, ymax = 39.0)
bbox_sf <- st_as_sfc(st_bbox(bbox))
st_crs(bbox_sf) <- crs

# Filter sensors within bounding box
purpleairs_sf <- st_intersection(pa_sf, bbox_sf)
total_sensors <- length(unique(purpleairs_sf$sensor_index))

# Load California county boundaries for mapping
ca <- counties("California", cb = TRUE)

# Plot the sensors
ggplot() + 
  geom_sf(data = ca, color = "black", fill = "antiquewhite", size = 0.25) +
  geom_sf(data = purpleairs_sf, color = "purple", size = 0.1) +
  coord_sf(xlim = c(-123.8, -121.0), ylim = c(36.9, 39.0)) +
  theme(panel.background = element_rect(fill = "aliceblue")) + 
  labs(title = "PurpleAir Sensors in the Bay Area", 
       subtitle = paste0(total_sensors," sensors"),
       x = "Longitude", y = "Latitude")
```

## Set inputs for PurpleAir data

```{r, inputs-purple-air}
# Not sure which pm2.5 to use 
# descriptions for pm2.5_alt, written here:
# https://api.purpleair.com/#api-sensors-get-sensor-data
# https://community.purpleair.com/t/what-is-the-difference-between-cf-1-atm-and-alt/6442
fields <- c("pm2.5_alt", "pm2.5_alt_a", "pm2.5_alt_b",
            "pm2.5_atm", "pm2.5_atm_a", "pm2.5_atm_b", 
            "pm2.5_cf_1", "pm2.5_cf_1_a", "pm2.5_cf_1_b",
            "rssi", "uptime", "memory", "humidity", "temperature",
            "pressure", "analog_input")
average <- "60"

# Date range for data download (2018-2019)
start_date <- as.Date("2018-01-01")
end_date <- as.Date("2019-12-31")
```

## Download Purple Air Hourly Data for 2018-2019

```{r, download-data}
# only download if file doesnt exist
filename <- paste0("purpleair_", start_date, "_", end_date, ".csv")
filepath <- file.path(purpleair_directory, filename)
if (!file.exists(filepath)) {
  filtered_sensors_sf <- purpleairs_sf %>% 
    filter(last_seen >= start_date) %>% 
    filter(date_created <= end_date) %>% 
    select(sensor_index, location_type) %>%
    st_drop_geometry()
  
  sensor_ids <- unique(filtered_sensors_sf$sensor_index)
  
  # Get PurpleAir data
  purpleair_data <- getSensorHistory(
    sensorIndex = sensor_ids,
    apiReadKey = api_key,
    startDate = start_date,
    endDate = end_date,
    average = average,
    fields = fields
  )
  
  purpleair_data <- left_join(purpleair_data, filtered_sensors_sf, by = "sensor_index")
  
  # Save to CSV file
  write.csv(purpleair_data, file = filepath, row.names = FALSE)
}
```

```{r, read-purpleair-csv, echo = FALSE}
# Read purple air data
purpleair_data <- read.csv(filepath)
```

# PurpleAir Bay Area Hourly 2018-2019

```{r, data-head, echo = FALSE}
knitr::kable(head(purpleair_data, 3), row.names = FALSE, format = "markdown")
```

```{r, data-dict, echo = FALSE}
desc <- data_description(
  purpleair_data,
  var_desc = 
    c("UTC (Unix) time stamp for that row of data.",
      "The WiFi signal strength.",
      "The time in minutes since the firmware started as last reported by the sensor.",
      "Free HEAP memory in Kb.",
      "Relative humidity inside of the sensor housing (%). This matches the 'Raw Humidity' map layer and on average is 4% lower than ambient conditions. Null if not equipped.",
      "Temperature inside of the sensor housing (F). This matches the 'Raw Temperature' map layer and on average is 8°F higher than ambient conditions. Null if not equipped.",
      "Current pressure in Millibars.",
      "If anything is connected to it, the analog voltage on ADC input of the PurpleAir sensor control board.",
      "Estimated mass concentration PM2.5 (µg/m³). PM2.5 are fine particulates with a diameter of fewer than 2.5 microns. ALT Formula for estimation.",
      "Channel A ALT variant",
      "Channel B ALT variant",
      "Estimated mass concentration PM2.5 (µg/m³). ATM Formula for estimation.",
      "PM2.5 ATM Channel A.",
      "PM2.5 ATM Channel B.",
      "Estimated mass concentration PM2.5 (µg/m³). CF=1 Formula for estimation.",
      "PM2.5 CF=1 Channel A.",
      "PM2.5 CF=1 Channel B.",
      "The sensor's index. Can be used to add a sensor to a group or view its details.",
      "The location type. Possible values are: 0 = Outside or 1 = Inside."
    ))

data_dictionary(purpleair_data, data_title = "PurpleAir Bay Area Hourly 2018-2019", descriptions = desc, top_n = 3)
```

```{r, data-summ, echo = FALSE}
data_summary(purpleair_data, data_title = "PurpleAir Bay Area Hourly 2018-2019", var_types = c(time_stamp = "date"))
```

## Map PurpleAir Sensors Bay Area (2018-2019)

```{r, map-sensors, message = FALSE, results = "hide"}
purpleairs_sf_filtered <- purpleairs_sf %>% 
  filter(sensor_index %in% unique(purpleair_data$sensor_index)) %>% 
  select(sensor_index)

ca <- counties("California", cb = TRUE)
num_sensors <- length(unique(purpleairs_sf_filtered$sensor_index))

ggplot() + 
  geom_sf(data = ca, color="black", fill="antiquewhite", size=0.25) +
  geom_sf(data = purpleairs_sf_filtered, color = "purple", size = 0.1) +
  coord_sf(xlim = c(-123.8, -121.0), ylim = c(36.9, 39.0)) +
  theme(panel.background = element_rect(fill = "aliceblue")) + 
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("PurpleAir Sensors in the Bay Area", subtitle = paste0(num_sensors," sensors in 2018-2019"))
```

## Plot Sensors by Month

```{r, monthly-sensors}
# Add column for month
purpleair_data$month <- format(as.Date(purpleair_data$time_stamp), "%Y-%m")

# Sensors for each month
monthly_sensors <- purpleair_data %>% select(month, sensor_index) %>% distinct()

sensor_counts <- monthly_sensors %>%
  group_by(month) %>%
  summarise(sensor_count = n_distinct(sensor_index))

ggplot(sensor_counts, aes(x = month, y = sensor_count)) +
  geom_bar(stat = "identity", fill = "lavender", color = "black") +
  labs(title = "Active PurpleAir Sensors By Month",
       x = "Month",
       y = "Number of Sensors") +
  scale_y_continuous(breaks = seq(0, max(sensor_counts$sensor_count) + 100, by = 100)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
