---
title: "Preprocessing PurpleAir"
output: github_document
always_allow_html: true
---

# Clean PurpleAir data points

```{r setup, include=FALSE}
api_key <- readr::read_file("inputs/purpleair_key.txt")
purpleair_directory <- readr::read_file("inputs/purpleair_directory.txt")
preprocessing_directory <- readr::read_file("inputs/preprocessing_directory.txt")
```

## Load required libraries

```{r, load-libraries, message = FALSE, warning = FALSE}
library(dplyr)        # For data manipulation
library(data.table)   # Faster than dataframes (for big files)
library(ggplot2)      # Plots
library(plotly)       # Interactive plots
library(lubridate)    # Dates
library(sf)           # Shapefiles
library(leaflet)      # Interactive maps
library(kableExtra)   # Printing formatted tables
library(zoo)          # for rolling calculations
library(purpleAirAPI) # Download PurpleAir Data
library(tidyr)        # Reshape data
library(DataOverviewR)
```

## Read files

```{r, read-files, eval = TRUE}
# Read files
purpleair_data <- fread(file.path("/Users", "heba", "Documents", "GitHub", "old", "purpleair_2018-01-01_2019-12-31.csv"))
# purpleair_data <- fread(file.path(purpleair_directory, "purpleair_2018-01-01_2019-12-31.csv"))
epa_data <- read.csv(file.path(preprocessing_directory, "EPA_airquality.csv"))

# convert timestamp to datetime
purpleair_data <- purpleair_data %>% 
  mutate(time_stamp = lubridate::as_datetime(time_stamp))

# Get total number of rows for full dataset
total_rows <- nrow(purpleair_data)
```
```{r, view-epa, echo = FALSE}
knitr::kable(head(epa_data, 3), row.names = FALSE, format = "markdown")
```


```{r, epa-dict, echo = FALSE}
# https://aqs.epa.gov/aqsweb/documents/AQS_Data_Dictionary.html
poc = "This is the 'Parameter Occurrence Code' used to distinguish different instruments that measure the same parameter at the same site. There is no meaning to the POC (e.g. POC 1 does not indicate the primary monitor). For example, the first monitor established to measure carbon monoxide (CO) at a site could have a POC of 1. If an additional monitor were established at the same site to measure CO, that monitor could have a POC of 2. However, if a new instrument were installed to replace the original instrument used as the first monitor, that would be the same monitor and it would still have a POC of 1."

desc <- data_description(
  epa_data,
  var_desc = c(
    "timestamp" = "The date and time, in local standard time, to which the NAAQS average calculation applies.",
    "id" = "AQS Monitor ID",
    "state_code" = "The FIPS code of the state in which the monitor resides.",
    "county_code" = "The FIPS County Code where the monitor resides.",
    "site_number" = "An identifier for the site in the onwning agency's (e.g., not US EPA) numbering scheme.",
    "poc" = "This is the 'Parameter Occurrence Code' used to distinguish different instruments that measure the same parameter at the same site.",
    "pm25" = "PM2.5 - Local Conditions",
    "latitude" = "The angular distance north or south of the equator measured in decimal degrees. North is positive.",
    "longitude" = "The angular distance east or west of the prime meridian measured in decimal degrees. East is positive, West is negative."))

data_dictionary(epa_data, data_title = "U.S. Environmental Protection Agency", descriptions = desc, hide = "top_n")
```

```{r, epa-summ, echo = FALSE}
data_summary(epa_data, data_title = "U.S. Environmental Protection Agency")
```


## Comparing PurpleAir air quality measurements with EPA
### EPA: U.S. Environmental Protection Agency
```{r, pa-epa-quantiles}
quants_vals <- c(0.75, 0.95, 0.99, 0.999)
quants <- c("75%","95%","99%","99.9%")
summary_statistics <- purpleair_data %>%
  reframe(
    across(c(pm2.5_atm, pm2.5_atm_a, pm2.5_atm_b),
           ~tibble(val = round(quantile(.x, quants_vals, na.rm = TRUE),0)),
           .unpack = TRUE)) %>%
  mutate(`Quantiles` = quants,
         epa = quantile(epa_data$pm25, quants_vals, na.rm = TRUE)) %>%
  rename(`EPA PM2.5` = epa,
         `PurpleAir PM2.5` = pm2.5_atm_val,
         `Channel A PM2.5` = pm2.5_atm_a_val,
         `Channel B PM2.5` = pm2.5_atm_b_val) %>%
  select(`Quantiles`, `EPA PM2.5`, everything())

knitr::kable(summary_statistics,
             row.names = FALSE,
             format = "markdown")
```

### Box Plots
```{r, box-plot}
img_path <- file.path(preprocessing_directory, "plots", "boxplots.png")

if (!file.exists(img_path)) {
  # Combine relevant columns into a single data frame
  combined_data <- data.frame(
    PurpleAir = purpleair_data$pm2.5_atm,
    PurpleAirChannelA = purpleair_data$pm2.5_atm_a,
    PurpleAirChannelB = purpleair_data$pm2.5_atm_b
  )
  
  # Reshape the data to long format for plotting
  long_data <- combined_data %>%
    pivot_longer(cols = everything(),  # All columns
                 names_to = "Measurement", 
                 values_to = "Value")
  
  # Add EPA data
  epa <- data.frame(Measurement = "EPA", Value = epa_data$pm25)
  long_data <- rbind(long_data, epa)
  long_data <- long_data %>% na.omit()
  
  # Box plots
  p <- ggplot(long_data, aes(x = Measurement, y = Value)) +
    geom_boxplot(fill = "lightblue") +
    # ylim(0, 50) +
    coord_cartesian(ylim = c(0, 30)) +
    labs(title = "Boxplot Comparison: PurpleAir and EPA PM2.5 Data",
         subtitle = "y-axis limit set to 30; more data points beyond the limit",
         x = "Measurement",
         y = "PM2.5 Value (µg/m³)") +
    theme_minimal()
  ggsave(filename = img_path, plot = p, width = 6, height = 4)
}
knitr::include_graphics(img_path)
```

## PurpleAir histograms (filtered between 1st and 99th percentile for clarity)
```{r, hist}
cols <- c("rssi", "uptime", "memory", "humidity", "temperature", "pressure", "analog_input", "pm2.5_atm", "pm2.5_atm_a", "pm2.5_atm_b")

# Set the layout to 2 plots per row
par(mfrow = c(ceiling(length(cols) / 2), 2))  # Adjust number of rows and columns as needed

# Loop through the columns and plot histograms
for (col in cols) {
  x <- purpleair_data[[col]]
  x <- x[x >= quantile(x, 0.01, na.rm = TRUE) & x <= quantile(x, 0.99, na.rm = TRUE)]
  hist(x, main = paste("Histogram of", col), xlab = col)
}
```

## Flag values over 500 and missing values
```{r, flag-na-highvals}
purpleair_data <- purpleair_data %>%
  mutate(missinga = ifelse(is.na(pm2.5_atm_a), 1, 0),
         missingb = ifelse(is.na(pm2.5_atm_b), 1, 0),
         over500a = ifelse(missinga == 0 & pm2.5_atm_a > 500, 1, 0),
         over500b = ifelse(missingb == 0 & pm2.5_atm_b > 500, 1, 0),
         flag = case_when(
           is.na(pm2.5_atm_a) | is.na(pm2.5_atm_b) ~ "Missing",
           over500a == 1 | over500b == 1 ~ "PM2.5 > 500",
           TRUE ~ "Normal"),
         pm2.5_atm_a = ifelse(is.na(pm2.5_atm_a),-1,pm2.5_atm_a),
         pm2.5_atm_b = ifelse(is.na(pm2.5_atm_b),-1,pm2.5_atm_b)
  )
```

### Flag PM2.5 as greater than 500, missing or normal
PM2.5 > 500:    Channel A or B is greater than 500
Missing:        Channel A or B has a missing value (Replaced NA with -1 for plotting)
Normal:         Channel A and B are not missing and not greater than 500
```{r, view-flag, echo = FALSE}
normal_example <- purpleair_data %>% 
  filter(flag == "Missing") %>% 
  select(time_stamp, sensor_index, pm2.5_atm, pm2.5_atm_a, pm2.5_atm_b, flag) %>%
  sample_n(3)

missing_example <- purpleair_data %>% 
  filter(flag == "Normal") %>% 
  select(time_stamp, sensor_index, pm2.5_atm, pm2.5_atm_a, pm2.5_atm_b, flag) %>%
  sample_n(3)

over500_example <- purpleair_data %>% 
  filter(flag == "PM2.5 > 500") %>% 
  select(time_stamp, sensor_index, pm2.5_atm, pm2.5_atm_a, pm2.5_atm_b, flag) %>%
  sample_n(3)

knitr::kable(rbind(normal_example, missing_example, over500_example),
             row.names = FALSE,
             format = "markdown")
```

```{r, flag-counts, echo = FALSE}
# Counts for flags: Normal, Missing, PM2.5 > 500
data_summary <- purpleair_data %>% 
  group_by(flag) %>% 
  summarize(count = n(), .groups = 'drop') %>% 
  mutate(percentage = paste0(round(100 * count / total_rows), "%")) %>%
  arrange(desc(count)) %>% 
  rbind(data.frame(flag = "Total", count = total_rows, percentage = "100%")) %>%
  mutate(count = format(count, big.mark = ","))

knitr::kable(data_summary,
             row.names = FALSE,
             format = "markdown",
             align = 'lrr',
             col.names = c("Flag", "Count", "Percentage")) %>%
  kable_styling()
```

## Initial plot channel A vs B
```{r, plot-channel-a-b, warning=FALSE}
img_path <- file.path(preprocessing_directory, "plots", "purpleair_avsb1.png")

if (!file.exists(img_path)) {
  p <- ggplot(purpleair_data, aes(x = pm2.5_atm_a, y = pm2.5_atm_b, color = flag)) +
    geom_point() +
    labs(x = "Channel A PM2.5 (µg/m³)",
         y = "Channel B PM2.5 (µg/m³)",
         title = "PM2.5 Channel A vs B") +
    scale_color_manual(values = c("Normal" = "black", 
                                  "PM2.5 > 500" = "orange", 
                                  "Missing" = "red"),
                       name = "Flag") +
    theme_minimal()
  
  ggsave(filename = img_path, plot = p, width = 6, height = 4)
}
knitr::include_graphics(img_path)
```

## Channel A vs B limited to 1000 PM2.5
```{r, plot-channel-a-b-lim1000, eval = TRUE, warning=FALSE}
img_path <- file.path(preprocessing_directory, "plots", "purpleair_avsb2.png")

if (!file.exists(img_path)) {
  p <- ggplot(purpleair_data, aes(x = pm2.5_atm_a, y = pm2.5_atm_b, color = flag)) +
    geom_point() +
    labs(x = "Channel A PM2.5 (µg/m³)",
         y = "Channel B PM2.5 (µg/m³)",
         title = "PM2.5 Channel A vs B",
         subtitle = "Axes limits set to 1000; more data points beyond the limit") +
    scale_color_manual(values = c("Normal" = "black", 
                                  "PM2.5 > 500" = "orange", 
                                  "Missing" = "red"),
                       name = "Flag") +  # Custom legend title
    theme_minimal() +
    xlim(-1, 1000) +
    ylim(-1, 1000)
  
  ggsave(filename = img_path, plot = p, width = 6, height = 4)
}

knitr::include_graphics(img_path)
```

## Look at associations between variables
```{r}
library(timeDate) # For holidays

# Get holidays for 2018 and 2019
holidays <- as.Date(c(holidayNYSE(2019), holidayNYSE(2018)))

purpleair_df <- data.frame(purpleair_data)
purpleair_df <- purpleair_df %>%
  mutate(
    local_timestamp = with_tz(time_stamp, tzone = "America/Los_Angeles"),
    local_date = as.Date(local_timestamp, tz="America/Los_Angeles"),
    dow = lubridate::wday(local_timestamp),
    hour = lubridate::hour(local_timestamp),
    day = lubridate::day(local_timestamp),
    month = lubridate::month(local_timestamp),
    year = lubridate::year(local_timestamp),
    wknd = ifelse(dow %in% c(6, 7), 1, 0),
    holiday = ifelse(local_date %in% holidays, 1, 0)
  ) %>% select(-local_timestamp, -local_date)
```

```{r}
library(gmodels)
CrossTable(x = purpleair_df$hour, y = purpleair_df$pm2.5_atm)
```


```{r}
library(psych)
pairs.panels(purpleair_df[c("day","hour", "pm2.5_atm")])
```


```{r}
pairs(purpleair_df[c("day","hour", "pm2.5_atm")])
```

## Flag outliers with different thresholds of relative change between channel A and B
### Relative Change
\[
\text{Relative Change} = \frac{\lvert \text{Channel A}_{\text{PM2.5}} - \text{Channel B}_{\text{PM2.5}} \rvert}{\text{avg}(\text{Channel A}_{\text{PM2.5}}, \text{Channel B}_{\text{PM2.5}})}
\]

### Minimum *Absolute Difference* between A and B must be greater than 2
```{r, flag-outliers-thres}
# flag outliers using different thresholds and compare
# Initialize an empty data frame to store results
outlier_summary <- data.frame(
  threshold = numeric(0),
  num_outliers = numeric(0),
  percentage = numeric(0)
)

# Set thresholds for PM2.5 relative change 
# Relative change - Arithmetic mean change	(https://en.wikipedia.org/wiki/Relative_change#Indicators_of_relative_change)
thresholds <- c(0.1, 0.15, 0.2, 0.25, 0.3, 0.4, 0.5, 0.6)
for (threshold in thresholds) {
  outliers <- purpleair_data %>%
    mutate(abs_diff = abs(pm2.5_atm_a - pm2.5_atm_b),
           relativechange = round(abs_diff / pm2.5_atm, 2),
           flag = ifelse(flag == "Normal" & relativechange > threshold & abs_diff > 2,
                         "Outlier", flag))
  
  # Merge with original data and flag outliers
  pa_outliers <- purpleair_data %>% select(-flag) %>%
    left_join(outliers %>% select(time_stamp, sensor_index, flag, abs_diff, relativechange), 
              by = c("time_stamp", "sensor_index")) %>%
    select(time_stamp, pm2.5_atm_a, pm2.5_atm_b, abs_diff, relativechange,
           flag, everything())
  
  num_outliers <- pa_outliers %>% filter(flag == "Outlier") %>% nrow()
  percentage <- paste0(round(100 * num_outliers / total_rows, 2),"%")
  
  # Add the results to the data frame
  outlier_summary <- rbind(outlier_summary, 
                           data.frame(threshold = threshold, 
                                      num_outliers = format(num_outliers, big.mark = ","), 
                                      percentage = percentage))
}
```

```{r, view-outlier-thres, echo = FALSE}
knitr::kable(outlier_summary,
             row.names = FALSE,
             format = "markdown",
             col.names = c("Threshold", "Number of Outliers", "Percentage")) %>%
  kable_styling() %>%
  row_spec(1, bold = TRUE, background = "#FFFF99")
```


## Plot different thresholds to compare
```{r, plot-outliers-thres, echo=FALSE, out.width="49%", out.height="20%", fig.show='hold', fig.align='center'}
if (FALSE) {
  for (threshold in thresholds) {
    outliers <- purpleair_data %>%
      mutate(abs_diff = abs(pm2.5_atm_a - pm2.5_atm_b),
             relativechange = round(abs_diff / pm2.5_atm, 2),
             flag = ifelse(flag == "Normal" & relativechange > threshold & abs_diff > 2,
                           "Outlier", flag))
    
    # Merge with original data and flag outliers
    pa_outliers <- purpleair_data %>% select(-flag) %>%
      left_join(outliers %>% select(time_stamp, sensor_index, flag, abs_diff, relativechange), 
                by = c("time_stamp", "sensor_index")) %>%
      select(time_stamp, pm2.5_atm_a, pm2.5_atm_b, abs_diff, relativechange,
             flag, everything())
    p <- ggplot(pa_outliers, aes(x = pm2.5_atm_a, y = pm2.5_atm_b, color = flag)) +
      geom_point() +
      scale_color_manual(values = c("Normal" = "black", "Outlier" = "grey",
                                    "Missing" = "red", "PM2.5 > 500" = "orange"),
                         name = "") + 
      labs(x = "Channel A PM2.5",
           y = "Channel B PM2.5",
           color = "Flag",
           title = paste0("Threshold = ", threshold),
           subtitle = paste0("PM2.5 Channel A vs B\n",
                             "Axes limits set to 1000; more data points beyond the limit")) +
      theme_minimal() +
      xlim(-1, 1000) +
      ylim(-1, 1000)
    ggsave(filename = paste0(preprocessing_directory, "/plots/plot_threshold_", threshold, ".png"),
           plot = p, width = 6, height = 4)
  }
}

# compare plots of different thresholds
img_paths <- c()
for (threshold in c(0.1, 0.15, 0.2, 0.25, 0.3, 0.4, 0.5, 0.6)) {
  img_path <- paste0(preprocessing_directory, "/plots/plot_threshold_", threshold, ".png")
  img_paths <- c(img_paths, img_path)
}

knitr::include_graphics(img_paths)
```

## Using threshold of 0.1 relative change between channel A and B
## And maximum value of PM2.5 500 for channel A and B
```{r, flag-outliers}
# flag outliers using selected threshold
threshold = 0.1
outliers <- purpleair_data %>%
  mutate(abs_diff = abs(pm2.5_atm_a - pm2.5_atm_b),
         relativechange = round(abs_diff / pm2.5_atm, 2),
         flag = ifelse(flag == "Normal" & relativechange > threshold & abs_diff > 2,
                       "Outlier", flag))
# Merge with flagged and original data
pa_outliers <- purpleair_data %>% select(-flag) %>%
  left_join(outliers %>% select(time_stamp, sensor_index, flag, abs_diff, relativechange), 
            by = c("time_stamp", "sensor_index")) %>%
  select(time_stamp, pm2.5_atm_a, pm2.5_atm_b, abs_diff, relativechange, flag, everything())

outliers %>% select(pm2.5_atm, pm2.5_atm_a, pm2.5_atm_b, abs_diff, relativechange) %>% filter(relativechange < threshold) %>% arrange(desc(abs_diff))
```

```{r, include = FALSE}
# # For checking specific examples
# options(digits=2)
# 
# x <- pa_outliers %>%  filter(!is.na(pm2.5_atm_a), !is.na(pm2.5_atm_b)) %>%
#     select(time_stamp, pm2.5_atm_a, pm2.5_atm_b, abs_diff, relativechange, outlier, everything())
# x %>% filter(outlier==0) %>% slice_sample(n=10) %>% arrange(abs_diff)
# x %>% filter(outlier==1) %>% slice_sample(n=20) %>% arrange(abs_diff)
# x %>% sample_n(size=20, fac=pm2.5_atm) %>% arrange(outlier, abs_diff)
# x %>% sample_n(size=20, fac=relativechange) %>% arrange(outlier, abs_diff)
# x %>% filter(outlier==0, pm2.5_atm>100, abs_diff>10) %>% slice_sample(n=20) %>% arrange(abs_diff)
# x %>% filter(outlier==0, pm2.5_atm<150) %>% arrange(desc(abs_diff))
```

## Filter out high PM2.5 values (>500), missing channel data, and identified outliers

```{r, remove-outliers}
# Remove outliers and keep relevant columns
pa_filtered <- pa_outliers %>% 
  filter(flag == "Normal") %>%
  select(time_stamp, sensor_index, pm2.5_atm, pm2.5_atm_a, pm2.5_atm_b,
         rssi, uptime, memory, humidity, temperature, pressure, analog_input)
```

## Remove sensors with < 24 data points
```{r, low-data-sensors}
low_data_sensors <- pa_filtered %>% 
  group_by(sensor_index) %>% summarize(n = n()) %>% arrange(n) %>% filter(n < 24)
pa_filtered <- pa_filtered %>% 
  filter(!(sensor_index %in% low_data_sensors$sensor_index))
```

```{r, channel-a-b-plot, eval = TRUE, warning=FALSE}
if (FALSE) {
  p <- ggplot(pa_filtered, aes(x = pm2.5_atm_a, y = pm2.5_atm_b)) +
    geom_point() +
    labs(x = "Channel A PM2.5",
         y = "Channel B PM2.5",
         title = "PM2.5 Channel A vs B") +
    theme_minimal()
  
  ggsave(filename = paste0(preprocessing_directory, "/plots/pa_filtered.png"),
         plot = p, width = 6, height = 4)
}

img_path <- paste0(preprocessing_directory, "/plots/pa_filtered.png")
knitr::include_graphics(img_path)
```

## Remove 24 hour periods of zeros or missing data

```{r, rolling-zeros-missing}
start_time <- min(pa_filtered$time_stamp, na.rm = TRUE)
end_time <- max(pa_filtered$time_stamp, na.rm = TRUE)
all_timestamps <- seq(from = start_time, to = end_time, by = "hour")
all_sensor_indices <- unique(pa_filtered$sensor_index)
complete_timestamps <- expand.grid(sensor_index = all_sensor_indices,
                                   time_stamp = all_timestamps)
pa_complete <- complete_timestamps %>%
  left_join(pa_filtered, by = c("sensor_index", "time_stamp")) %>%
  mutate(pm2.5_atm = ifelse(is.na(pm2.5_atm), -1, pm2.5_atm))

pa_complete <- pa_complete %>%
  group_by(sensor_index) %>%
  mutate(
    is_zero_or_missing = ifelse(pm2.5_atm == 0 | pm2.5_atm == -1, 1, 0),
    is_normal = ifelse(pm2.5_atm != 0 & pm2.5_atm != -1, 1, 0),
    rolling_zeros_missing = rollapply(is_zero_or_missing, width = 24, FUN = sum,
                                      align = "right", fill = NA),
    rolling_normals = rollapply(is_normal, width = 24, FUN = sum, align = "right", fill = NA)
  ) %>%
  ungroup()

# threshold 0.8 means >=20 hours missing from a 24 hour time period
pa_complete <- pa_complete %>%
  mutate(
    proportion_zeros_missing = rolling_zeros_missing / 24,
    flag_high_proportion = ifelse(proportion_zeros_missing >= 0.8, 1, 0)
  ) 

pa_complete <- pa_complete %>% filter(flag_high_proportion != 1) %>%
  select(-is_zero_or_missing, -is_normal, -rolling_zeros_missing,
         -rolling_normals, -proportion_zeros_missing, -flag_high_proportion)
```

## Plot sensors with >20% zeros 

```{r, perc-zeros}
# Percentage of zero readings for each sensor
sensor_zero_readings <- pa_complete %>%
  group_by(sensor_index) %>%
  summarize(pct_zeros = round(100 * sum(pm2.5_atm == 0) / n(), 2),
            pct_missing = round(100 * sum(pm2.5_atm == -1) / n(), 2)) %>%
  filter(pct_zeros > 20)

# Loop through each sensor and create plots
for (i in 1:nrow(sensor_zero_readings)) {
  s <- sensor_zero_readings$sensor_index[[i]]
  data_sensor <- pa_complete %>% filter(sensor_index == s)
  n <- nrow(data_sensor)
  pz <- round(sensor_zero_readings$pct_zeros[i], 0)
  pm <- round(sensor_zero_readings$pct_missing[i], 0)
  
  # Create a data frame with segment information
  shifted_readings <- data.frame(
    time_stamp = head(data_sensor$time_stamp, -1), 
    time_stamp_shifted = tail(data_sensor$time_stamp, -1), 
    pm2.5_atm = head(data_sensor$pm2.5_atm, -1), 
    pm2.5_atm_shifted = tail(data_sensor$pm2.5_atm, -1)
  )
  
  # Assign colors based on whether the pm2.5_atm value is zero or not
  shifted_readings <- shifted_readings %>% 
    mutate(flag = ifelse(pm2.5_atm == 0, "Zero", ifelse(pm2.5_atm == -1, "Missing", "Normal")))
  
  # Plot the segments
  p <- ggplot(data=shifted_readings, aes(x=time_stamp, xend = time_stamp_shifted,
                                         y=pm2.5_atm, yend = pm2.5_atm_shifted, 
                                         color=flag)) +
    geom_segment() +
    scale_color_manual(values = c("Normal" = "black", "Missing" = "yellow",
                                  "Zero" = "red"),
                       name = "") + 
    labs(x = "Time", y = "PM2.5", 
         title = paste0("Sensor ", s, "\n",
                        pz, "% zeros", "\n", 
                        pm, "% missing",
                        "\nNumber of readings: ", n)) +
    theme_minimal()
  
  ggsave(filename = file.path(preprocessing_directory, "plots", paste0(
    "pct", pz, "_sensor", s, ".png")),
    plot = p, width = 8, height = 6)
}
```

## View plots of sensors with >20% zeros

```{r, zero-plots, echo=FALSE, out.width="49%", out.height="20%", fig.show='hold', fig.align='center'}
# compare plots of different thresholds
img_paths <- c()
for (i in 1:nrow(sensor_zero_readings)) {
  s <- sensor_zero_readings$sensor_index[[i]]
  pz <- round(sensor_zero_readings$pct_zeros[i], 0)
  img_path <- file.path(preprocessing_directory, "plots",
                        paste0("pct", pz, "_sensor", s, ".png"))
  img_paths <- c(img_paths, img_path)
}
knitr::include_graphics(img_paths)
```

## Remove sensor 20349 based on plots
```{r, remove-sensor}
pa_complete <- pa_complete %>%
  filter(sensor_index != 20349) %>% filter(pm2.5_atm != -1)
```

## Save Filtered Data to CSV

```{r, save-filtered-data, eval = TRUE}
# Save filtered data
write.csv(pa_complete, file = file.path(preprocessing_directory, "purpleair_filtered_2018-2019.csv"), row.names = FALSE)
```
